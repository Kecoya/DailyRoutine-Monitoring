# 系统更新说明 (2025-11-04)

## 功能改进

### 0. 优化监控间隔，提升数据精度 ✅ NEW!

**改进内容：**
- 数据保存间隔从 60秒 改为 **5秒**
- 时间粒度提升 **12倍**
- 忙碌曲线更加精细和准确

**重要说明：**
- 🎯 **鼠标距离测量本来就是实时的！** 鼠标监听器每次移动都会触发并累加距离
- ⏱️ 间隔调整只影响数据**保存到数据库**的频率
- ✅ 即使之前是60秒间隔，鼠标距离测量也是完全精确的
- 📈 改为5秒后，可以看到更细粒度的活动曲线

**性能影响：**
- 数据量增加：1年约1.2GB（原来100MB）
- CPU影响：可忽略不计（<0.01%）
- 适合日常使用和长期数据分析

**详细说明：** 请参考 `监控间隔优化说明.md`

### 1. 修复下班时间和工作时长计算逻辑 ✅

**问题描述：**
- 之前如果工作到第二天凌晨，这部分工作时间会被计入第二天，导致工作时长统计不准确

**解决方案：**
- 将工作日定义修改为：当天 00:00:00 到第二天 02:00:00
- 凌晨 0:00-2:00 的所有活动都会归入前一天的统计
- 下班时间现在可以正确显示为凌晨2点（如果工作到那时）

**影响范围：**
- `database.py` 中的 `update_daily_stats` 方法
- `analyzer.py` 中的 `generate_busy_curve` 方法
- 忙碌曲线图的X轴现在显示到26点（即第二天凌晨2点）

### 2. 添加鼠标移动距离统计功能 ✅

**新增功能：**
- 系统现在会记录并统计鼠标移动的总距离
- 使用欧几里得距离公式（勾股定理）计算采样点间的直线距离
- 显示单位：**米（m）**

**计算方法：**
- 原始数据：屏幕像素坐标
- 换算系数：`PIXELS_PER_METER = 3600` （基于24寸1920×1080显示器）
- 可在 `config.py` 中根据实际显示器调整换算系数

**数据字段：**
- `activity_records` 表：已有 `mouse_distance` 字段（像素）
- `daily_stats` 表：新增 `total_mouse_distance` 字段（像素）
- 数据库会自动检测并添加缺失的列，无需手动迁移

**显示位置：**
- 今日概览：显示今日鼠标移动总距离（米）
- 周报/月报/自定义报表：显示该时段鼠标移动总距离（米）
- Excel导出：包含鼠标移动距离统计

**精度说明：**
- 采用每分钟采样一次的方式
- 测量值可能略小于实际轨迹长度（因为是直线距离）
- 适合用于趋势对比和相对变化分析
- 详细原理请参考 `鼠标距离计算说明.md`

### 3. 改进工作状态评估指标 ✅

**问题描述：**
- 原来的"平均忙碌指数"是绝对值（0-100），不能很好地反映实际工作状态

**新增指标：**

#### 3.1 工作强度 (Work Intensity)
- **计算公式：** (活动时长 × 忙碌指数) / 平均活动时长
- **含义：** 综合考虑工作时长和忙碌程度的指标
- **用途：** 评估某段时间的工作投入程度

#### 3.2 专注度 (Focus Score)
- **计算公式：** 100 - (窗口切换次数 / 活动小时数)
- **含义：** 分数越高表示越专注，窗口切换越少
- **用途：** 评估工作时的专注程度，专注度高通常意味着深度工作

#### 3.3 效率指数 (Efficiency Score)
- **计算公式：** (鼠标点击 + 键盘按键) / 活动分钟数
- **含义：** 单位时间内的操作频率
- **用途：** 评估工作活跃度，但不代表实际产出

**显示位置：**
- 周报统计
- 月报统计
- 自定义时间段报表
- Excel导出

## 数据库更新

### 自动迁移
- 系统启动时会自动检测 `daily_stats` 表是否有 `total_mouse_distance` 列
- 如果没有，会自动添加该列（默认值为0）
- 无需手动操作

### 数据兼容性
- 所有新字段都有默认值，不会影响现有数据
- 旧数据的鼠标移动距离会显示为 0.00km

## 使用建议

### 理解新指标

1. **忙碌指数** vs **工作强度**
   - 忙碌指数：瞬时的工作繁忙程度（0-100）
   - 工作强度：一段时间内的综合投入程度

2. **专注度解读**
   - 90+ ：极度专注，可能在进行深度工作
   - 70-89：较为专注，工作稳定
   - 50-69：一般，有一定程度的任务切换
   - <50 ：频繁切换，可能在处理多个任务

3. **效率指数解读**
   - 这个指标反映操作频率，不等同于工作成效
   - 编码、写作等深度工作可能效率指数较低
   - 数据录入、测试等工作可能效率指数较高

### 查看新功能

1. 启动监控服务（如果未运行）
2. 打开Web界面（默认 http://127.0.0.1:5000）
3. 查看今日概览中的"鼠标移动"卡片
4. 查看本周/本月报表中的新增指标
5. 忙碌曲线图现在会显示到第二天凌晨2点

## 技术细节

### 修改的文件
- `database.py` - 数据库表结构和查询逻辑
- `analyzer.py` - 数据分析和报表生成
- `templates/index.html` - Web界面显示
- `monitor_service.py` - 已有鼠标距离采集功能

### 新增计算逻辑
所有新指标的计算都在 `analyzer.py` 的 `_generate_period_report` 方法中实现。

## 注意事项

1. **数据时区**：凌晨0-2点的数据会归入前一天，这是预期行为
2. **图表显示**：忙碌曲线图的X轴现在到26点，表示第二天凌晨2点
3. **历史数据**：新指标只对当前及未来的数据生效，历史数据的鼠标移动距离为0
4. **性能影响**：新增的计算对性能影响很小，可以放心使用
5. **鼠标距离换算**：
   - 默认配置适用于24寸 1920×1080显示器
   - 如果您的显示器规格不同，建议调整 `config.py` 中的 `PIXELS_PER_METER` 值
   - 详细调整方法请参考 `鼠标距离计算说明.md`
   - 即使不调整，相对趋势仍然准确

## 后续建议

1. 观察一周后，根据自己的工作模式调整对指标的理解
2. 可以将专注度和工作强度结合起来看，找到最佳工作状态
3. 如果需要调整计量标准，可以修改 `analyzer.py` 中的计算公式

---

如有问题或建议，欢迎反馈！

